**Arquivo: fase-04-api.clinerules**

---

### ğŸ“… FASE 04: API PHP (OO/MVC) â€“ Estrutura BÃ¡sica + Endpoints Simulados

**Objetivo principal:**
Implementar uma API PHP orientada a objetos, com estrutura MVC enxuta e trÃªs endpoints que retornam dados simulados (mock). A API deve aceitar requisiÃ§Ãµes autenticadas via JWT, atravÃ©s do Kong (Fase 03).

---

### âœï¸ INSTRUÃ‡Ã•ES DETALHADAS DE IMPLEMENTAÃ‡ÃƒO

#### 1. Estrutura de pastas da API
Dentro da pasta `api/`, crie a seguinte estrutura:

```
api/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.php
â”œâ”€â”€ controllers/
â”œâ”€â”€ models/
â””â”€â”€ routes/
```

#### 2. Dockerfile da API (caso ainda nÃ£o exista)
```Dockerfile
FROM php:8.2-apache
COPY ./public /var/www/html/
EXPOSE 80
```

#### 3. index.php (roteador simples)
```php
<?php
require_once '../routes/web.php';
```

#### 4. routes/web.php
```php
<?php

$uri = $_SERVER['REQUEST_URI'];
$method = $_SERVER['REQUEST_METHOD'];

if ($method === 'GET' && $uri === '/produtos') {
    require_once '../controllers/ProdutoController.php';
    (new ProdutoController())->listar();
} elseif ($method === 'GET' && $uri === '/usuarios') {
    require_once '../controllers/UsuarioController.php';
    (new UsuarioController())->listar();
} elseif ($method === 'GET' && $uri === '/pedidos') {
    require_once '../controllers/PedidoController.php';
    (new PedidoController())->listar();
} else {
    http_response_code(404);
    echo json_encode(['erro' => 'Rota nÃ£o encontrada']);
}
```

#### 5. controllers/ProdutoController.php
```php
<?php
class ProdutoController {
    public function listar() {
        header('Content-Type: application/json');
        echo json_encode([
            ['id' => 1, 'nome' => 'Produto A', 'preco' => 10.0],
            ['id' => 2, 'nome' => 'Produto B', 'preco' => 15.0],
        ]);
    }
}
```

#### 6. controllers/UsuarioController.php
```php
<?php
class UsuarioController {
    public function listar() {
        header('Content-Type: application/json');
        echo json_encode([
            ['id' => 1, 'nome' => 'JoÃ£o'],
            ['id' => 2, 'nome' => 'Maria'],
        ]);
    }
}
```

#### 7. controllers/PedidoController.php
```php
<?php
class PedidoController {
    public function listar() {
        header('Content-Type: application/json');
        echo json_encode([
            ['id' => 101, 'usuario' => 'JoÃ£o', 'total' => 100.0],
            ['id' => 102, 'usuario' => 'Maria', 'total' => 250.0],
        ]);
    }
}
```

---

### ğŸ”’ Middleware de AutenticaÃ§Ã£o (simplificado)

No momento, o Kong Ã© responsÃ¡vel por validar o JWT. Portanto, **nÃ£o Ã© necessÃ¡ria revalidaÃ§Ã£o do token no cÃ³digo PHP**. A aplicaÃ§Ã£o PHP apenas assume que o Kong **nÃ£o redirecionarÃ¡ para cÃ³digo PHP se o token for invÃ¡lido**.

Se desejar adicionar um middleware de validaÃ§Ã£o JWT futuramente, ele pode ser adicionado em `public/index.php`.

---

### ğŸ” CRITÃ‰RIOS DE VALIDAÃ‡ÃƒO

1. Os endpoints `GET /produtos`, `/usuarios` e `/pedidos` devem responder com JSON corretamente.
2. As rotas devem estar acessÃ­veis via Kong:
```bash
curl -H "Authorization: Bearer TOKEN_VALIDO" http://localhost:8000/api/produtos
```
3. A resposta deve conter os dados mockados de forma estruturada.
4. Sem o JWT, o Kong deve barrar com 401.

---

### âš ï¸ REGRAS DE COMPATIBILIDADE
- A API **nÃ£o deve repetir a validaÃ§Ã£o do JWT** (feito via Kong).
- As rotas devem responder de forma **determinÃ­stica** (sem lÃ³gica dinÃ¢mica).
- Os dados devem estar mockados no controller, **sem banco de dados**.

---

### ğŸš€ PRÃ“XIMOS PASSOS

Quando essa fase for concluÃ­da com sucesso, atualize o arquivo `control.clinecheckpoint` com:
```ini
[Fase 04] API PHP (OO/MVC): estrutura + endpoints mock = âœ… CONCLUÃDO
```

E prossiga para:
- `fase-05-bff.clinerules` â” ImplementaÃ§Ã£o do BFF PHP com chamadas autenticadas Ã  API via Kong.

