**Arquivo: fase-05-bff.clinerules**

---

### ğŸ“… FASE 05: BFF PHP â€“ IntegraÃ§Ã£o via JWT com a API (via Kong)

**Objetivo principal:**
Implementar um Backend-for-Frontend (BFF) em PHP orientado a objetos, com estrutura limpa, responsÃ¡vel por:
- Renderizar as pÃ¡ginas da aplicaÃ§Ã£o
- Armazenar o token JWT na sessÃ£o
- Orquestrar chamadas para a API via Kong

---

### âœï¸ INSTRUÃ‡Ã•ES DETALHADAS DE IMPLEMENTAÃ‡ÃƒO

#### 1. Estrutura de pastas
```
bff/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.php
â”œâ”€â”€ controllers/
â”œâ”€â”€ views/
â””â”€â”€ routes/
```

#### 2. Dockerfile do BFF
```Dockerfile
FROM php:8.2-apache
RUN docker-php-ext-install curl
COPY ./public /var/www/html/
EXPOSE 80
```

#### 3. index.php
```php
<?php
session_start();
require_once '../routes/web.php';
```

#### 4. routes/web.php
```php
<?php

$uri = $_SERVER['REQUEST_URI'];

if ($uri === '/' || $uri === '/inicio') {
  require_once '../controllers/HomeController.php';
  (new HomeController())->index();
} elseif ($uri === '/produtos') {
  require_once '../controllers/ProdutoController.php';
  (new ProdutoController())->listar();
} elseif ($uri === '/usuarios') {
  require_once '../controllers/UsuarioController.php';
  (new UsuarioController())->listar();
} elseif ($uri === '/pedidos') {
  require_once '../controllers/PedidoController.php';
  (new PedidoController())->listar();
} elseif ($uri === '/logout') {
  session_destroy();
  header('Location: /');
} else {
  echo 'PÃ¡gina nÃ£o encontrada';
}
```

#### 5. Exemplo de controller: ProdutoController.php
```php
<?php
class ProdutoController {
  public function listar() {
    session_start();
    if (!isset($_SESSION['jwt'])) {
      echo 'UsuÃ¡rio nÃ£o autenticado';
      return;
    }

    $jwt = $_SESSION['jwt'];
    $curl = curl_init();
    curl_setopt_array($curl, [
      CURLOPT_URL => 'http://kong:8000/api/produtos',
      CURLOPT_RETURNTRANSFER => true,
      CURLOPT_HTTPHEADER => ["Authorization: Bearer $jwt"]
    ]);
    $response = curl_exec($curl);
    curl_close($curl);

    $dados = json_decode($response, true);
    include '../views/produtos.php';
  }
}
```

#### 6. views/produtos.php
```php
<h2>Lista de Produtos</h2>
<ul>
  <?php foreach ($dados as $item): ?>
    <li><?= $item['nome'] ?> - R$ <?= $item['preco'] ?></li>
  <?php endforeach; ?>
</ul>
```

---

### ğŸ” LOGIN (serÃ¡ feito na Fase 06)
Nesta fase o JWT serÃ¡ **armazenado manualmente na sessÃ£o** para teste. Exemplo:
```php
// Simula login manual
$_SESSION['jwt'] = 'INSIRA_AQUI_UM_TOKEN_VALIDO_DO_KEYCLOAK';
```

---

### ğŸ” CRITÃ‰RIOS DE VALIDAÃ‡ÃƒO

1. A BFF deve responder em `http://localhost:8080` com menu e pÃ¡ginas bÃ¡sicas.
2. As pÃ¡ginas `/produtos`, `/usuarios` e `/pedidos` devem buscar dados da API via Kong.
3. Sem JWT vÃ¡lido na sessÃ£o, as pÃ¡ginas devem bloquear o acesso e exibir erro de autenticaÃ§Ã£o.

---

### âš ï¸ REGRAS DE COMPATIBILIDADE
- As requisiÃ§Ãµes para a API devem ser feitas via Kong (`http://kong:8000`).
- O JWT usado deve ser o mesmo emitido na Fase 02 e aceito na Fase 03.
- O layout da view deve ser simples e preparado para integraÃ§Ã£o com Bootstrap (Fase 07).

---

### ğŸš€ PRÃ“XIMOS PASSOS

Quando essa fase estiver concluÃ­da e validada, atualize:
```ini
[Fase 05] BFF PHP: orquestraÃ§Ã£o + integraÃ§Ã£o via JWT = âœ… CONCLUÃDO
```

E prossiga para:
- `fase-06-login-keycloak.clinerules` â†’ onde serÃ¡ feita a autenticaÃ§Ã£o real com Keycloak e obtenÃ§Ã£o automÃ¡tica do JWT via OAuth2.

